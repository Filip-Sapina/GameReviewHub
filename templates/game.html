{% extends "base.html" %}

{% block title %}{{game.title}} - Games Review Hub{% endblock %}

{% block content %}

{% set user_logged_in = user.user_id is defined and user.user_id is not none %}
<article class="main-game-container grid">
    <!-- Image -->
    <div>
        <img src="{{game.image_link}}" alt="{{game.title}} cover image.">
    </div>

    <div>

        <!-- Title -->
        <h1 style="text-align: center;">{{game.title}}</h1>
        <!-- Rating -->
        <div class="container-fluid rating-container">
            <span>1</span>
            <progress value="8" max="10" id="rating"></progress>
            <span>10</span>
        </div>
        <!-- Platforms and Accessibility -->
        <div class="grid">
            <div class="platforms">
                {% for platform in platforms %}
                <span class="platform">{{platform.name}}</span>
                {% endfor %}
            </div>
            <div class="accessibility container">
                <span class="material-symbols-outlined">subtitles</span>
                <input type="checkbox" name="subtitles" disabled>
                <span class="material-symbols-outlined">visibility</span>
                <input type="checkbox" name="colourblind_options" disabled checked>
                <span class="material-symbols-outlined">swords</span>
                <input type="checkbox" name="difficulty_options" disabled>
            </div>
        </div>
        <!-- Description -->
        <div class="description">
            <details open>
                <summary>Description</summary>
                <p>{{game.description}}</p>
            </details>
        </div>
    </div>
</article>

<!-- Write Your Own Review -->
<div class="container user-review">


    <form action="{{ url_for('game_page', game_id=game.game_id) }}" method="post" aria-label="Write Review">
        <div class="user-review-top">
            <!-- If user is logged in, display text as normal. Otherwise Replace with red warning message.-->
            {% if not user_logged_in %}
            <h4 style="color: var(--negative-color);"> Login In To Write A Review! </h4>
            {% elif user_review %}
            <h4 style="color: var(--positive-color)"> Edit Review </h4>
            {% else %}
            <h4> Your Review </h4>
            {% endif %}
            <!-- Accessibility Options -->
            <fieldset class="form-group user-accessibility" {% if not user_logged_in %} disabled {% endif %}>
                <label for="has_subtitles" class="material-symbols-outlined">subtitles</label>
                <input type="checkbox" name="has_subtitles" id="user-subtitles" {% if user_review and
                    user_review.accessibility.has_subtitles %} checked {% endif %}>
                <label for="has_colourblind_support" class="material-symbols-outlined">visibility</label>
                <input type="checkbox" name="has_colourblind_support" id="user-colourblind" {% if user_review and
                    user_review.accessibility.has_colourblind_support %} checked {% endif %}>
                <label for="has_difficulty_options" class="material-symbols-outlined">swords</label>
                <input type="checkbox" name="has_difficulty_options" id="user-difficulty-options" {% if user_review and
                    user_review.accessibility.has_difficulty_options %} checked {% endif %}>
            </fieldset>

        </div>
        <!-- Ratings Slider -->
        <label for="rating">Rating (<span id="rating-value-display">0</span>)</label>
        <div class="form-group user-rating-container">
            <span>1</span>
            <input type="range" name="rating" id="user-rating" min="0" max="10"
                value="{% if user_review %} {{user_review.rating}} {% else %} 0 {% endif %}" {% if not user_logged_in %}
                disabled {% endif %}>
            <span>10</span>
        </div>
        <div class="form-group">
            <!-- Place to write Text for Review -->
            <textarea maxlength="1000" name="review_text" id="review_text" cols="30" rows="5"
                placeholder="Write Your Review Here!" {% if not user_logged_in %} disabled {% endif
                %}>{% if user_review %}{{user_review.review_text}}{% endif %}</textarea>
        </div>
        <!-- What Platform user played game on -->
        <div class="user-review-bottom">
            <div class="form-group">
                <fieldset aria-label="Platforms" {% if not user_logged_in %} disabled {% endif %}>
                    <legend>Platform</legend>
                    {% for platform in platforms %}
                    <li>
                        <input type="radio" name="user_platform" id="user-platform-{{platform.name}}"
                            value="{{platform.name}}" required {% if user_review and
                            user_review.platform_id==platform.platform_id %} checked {% endif %}>
                        <label for="user-platform-{{platform.name}}">{{platform.name}}</label>
                    </li>
                    {% endfor %}
                </fieldset>
            </div>
            <div class="form-group user-review-post-button">
                <!-- Post Review -->
                <button type="submit" {% if not user_logged_in %} disabled {% endif %}>
                    {% if not user_review %}
                    Post
                    {% else %}
                    Edit
                    {% endif %}
                </button>

            </div>
        </div>



        <!-- Put method to update review instead of creating new review. -->
        {% if user_review %}
        <input type="hidden" name="_method" value="PUT">
        {% endif %}
    </form>


</div>

<!-- Review Filters -->
<div class="review-filter container grid">

    <button class="material-symbols-outlined" id="positive-reviews">thumb_up</button>
    <button class="material-symbols-outlined" id="mixed-reviews">~</button>
    <button class="material-symbols-outlined" id="negative-reviews">thumb_down</button>
</div>
<div class="reviews grid">
    <!-- Other Peoples Reviews -->
    {% for review in reviews %}
    <div class="review">
        <div class="review-top">
            <h4 class="review-username">{{review.user.username}}</h4>
            <div class="review-rating">{{review.rating}} / 10</div>
        </div>
        <div class="review-middle">
            <div class="accessibility grid">
                <span class="material-symbols-outlined">subtitles</span>
                <input type="checkbox" name="subtitles" disabled {% if review.accessibility.has_difficulty_options %}
                    checked {% endif %}>
                <span class="material-symbols-outlined">visibility</span>
                <input type="checkbox" name="colourblind_options" disabled {% if
                    review.accessibility.has_colourblind_support %} checked {% endif %}>
                <span class="material-symbols-outlined">swords</span>
                <input type="checkbox" name="difficulty_options" disabled {% if review.accessibility.has_subtitles %}
                    checked {% endif %}>
            </div>
            <p class="review-text">
                {{review.review_text}}
            </p>
        </div>
        <div class="review-bottom">
            <span>{{review.platform.name}}</span>
            <span>{{review.review_date}}</span>
        </div>
    </div>

    {% endfor %}
</div>

<script>
    rating_display = document.getElementById("rating-value-display");
    rating_slider = document.getElementById("user-rating");
    value = rating_slider.value;
    rating_display.textContent = value;

    rating_slider.addEventListener("input", () => {
        value = rating_slider.value;
        rating_display.textContent = value;
    })

    function fetchReviews(filter) {
        fetch(`/filter_reviews?filter=${filter}&game_id={{game.game_id}}`)
            .then(response => response.json())
            .then(data => {
                console.log(data)

                const reviewsContainer = document.querySelector('.reviews.grid');
                reviewsContainer.innerHTML = data.map(([review, user, platform]) => `
                <div class="review">
                    <div class="review-top">
                    <h4 class="review-username">${user.username}</h4>
                    <div class="review-rating">${review.rating} / 10</div>
                    </div>
                    <div class="review-middle">
                    <div class="accessibility grid">
                        <span class="material-symbols-outlined">subtitles</span>
                        <input type="checkbox" name="subtitles" disabled ${review.accessibility.has_subtitles ? 'checked' : ''}>
                        <span class="material-symbols-outlined">visibility</span>
                        <input type="checkbox" name="colourblind_options" disabled ${review.accessibility.has_colourblind_support ? 'checked' : ''}>
                        <span class="material-symbols-outlined">swords</span>
                        <input type="checkbox" name="difficulty_options" disabled ${review.accessibility.has_difficulty_options ? 'checked' : ''}>
                    </div>
                    <p class="review-text">${review.review_text}</p>
                    </div>
                    <div class="review-bottom">
                    <span>${platform.name}</span> <br>
                    <span>${new Date(review.review_date * 1000).toLocaleDateString()}</span>
                    </div>
                </div>
                `).join('');

            })
            .catch(error => {
                console.error('Fetch error:', error);
            });
    }
    ['positive', 'mixed', 'negative'].forEach(filter => {
        document.getElementById(`${filter}-reviews`).addEventListener('click', () => fetchReviews(filter));
    });

</script>


{% endblock %}